<!DOCTYPE html>
<html>
  <head>
    <title>Expenses</title>
  </head>
  <body>
    <h1>Expenses</h1>

    <h2>Add Expense</h2>
    <form id="addExpenseForm">
      <div>
        <label for="expenseAmount">Expense Amount:</label>
        <input type="number" id="amount" name="amount" step="0.01" required />
      </div>
      <div>
        <label for="category">Category:</label>
        <select id="category" name="category" required>
          <option value="food">Food</option>
          <option value="petrol">Petrol</option>
          <option value="movies">Movies</option>
          <option value="stationery">Stationery</option>
          <option value="electronics">Electronics</option>
        </select>
      </div>
      <div>
        <label for="description">Description:</label>
        <input type="text" id="description" name="description" required />
      </div>
      <button type="submit">Add Expense</button>
    </form>

    <div>
      <button onclick="createOrder()">Buy Premium</button>
    </div>

    <h2>Expense List</h2>
    <ul id="expenseList"></ul>

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
      function createOrder(event) {
        const userDetails = JSON.parse(localStorage.getItem("userDetails"));
        const userId = userDetails ? userDetails.id : null;
        const token = localStorage.getItem("token");

        if (userId) {
          const order_id = `${userId}_${Date.now()}`;
          const orderData = {
            order_id: order_id,
            amount: 100, // Replace "100" with the actual amount for premium purchase
            currency: "INR", // Replace "INR" with the actual currency code
          };

          fetch("http://localhost:8080/payment/create-order", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(orderData),
          })
            .then((response) => {
              if (response.ok) {
                return response.json();
              } else {
                throw new Error("Failed to create order");
              }
            })
            .then((response) => {
              let { razorpay_order_id, amount, currency } = response;
              var options = {
                key: "rzp_test_FePwfV1JgZ9mFf",
                order_id: razorpay_order_id,
                handler: async (response) => {
                  alert("Payment Successfull");
                },
              };
              var rzp1 = new Razorpay(options);
              rzp1.open();
              rzp1.on("payment.failed", function (response) {
                alert(response.error.code);
                alert(response.error.description);
                alert(response.error.source);
                alert(response.error.step);
                alert(response.error.reason);
                alert(response.error.metadata.order_id);
                alert(response.error.metadata.payment_id);
              });
            })
            .catch((error) => {
              console.log(error);
              // alert(error.message);
            });
        } else {
          alert("User details not found. Please log in again.");
        }
      }
      // Function to render the expense list
      function renderExpenseList(expenses) {
        const expenseList = document.getElementById("expenseList");
        expenseList.innerHTML = "";

        expenses.forEach((expense) => {
          const listItem = document.createElement("li");

          // Expense details
          const expenseAmount = parseFloat(expense.amount);
          const expenseDetails = `Amount: $${expenseAmount.toFixed(
            2
          )} | Category: ${expense.category} | Description: ${
            expense.description
          }`;

          // Delete button
          const deleteButton = document.createElement("button");
          deleteButton.textContent = "Delete";
          deleteButton.addEventListener("click", () => {
            const userDetails = JSON.parse(localStorage.getItem("userDetails"));
            const userId = userDetails ? userDetails.id : null;
            if (userId) {
              deleteExpense(userId, expense.id);
            } else {
              alert("User details not found. Please log in again.");
            }
          });

          listItem.textContent = expenseDetails;
          listItem.appendChild(deleteButton);
          expenseList.appendChild(listItem);
        });
      }

      // Function to fetch and display expenses
      function fetchExpenses() {
        const userDetails = JSON.parse(localStorage.getItem("userDetails"));
        const userId = userDetails ? userDetails.id : null;
        const token = localStorage.getItem("token");

        if (userId) {
          fetch(`http://localhost:8080/expense/all-expenses`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          })
            .then((response) => {
              if (response.ok) {
                return response.json();
              } else {
                throw new Error("Failed to retrieve expenses");
              }
            })
            .then((expenses) => {
              renderExpenseList(expenses);
            })
            .catch((error) => {
              console.error("Error:", error);
              alert(error.message);
            });
        } else {
          alert("User details not found. Please log in again.");
        }
      }

      // Function to delete an expense
      // Function to delete an expense
      function deleteExpense(userId, expenseId) {
        const token = localStorage.getItem("token"); // Fetch the token from local storage

        fetch(
          `http://localhost:8080/expense/delete-expense?expenseId=${expenseId}`,
          {
            method: "DELETE",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          }
        )
          .then((response) => {
            if (response.ok) {
              alert("Expense deleted successfully!");
              fetchExpenses(); // Fetch and display updated expenses
            } else {
              throw new Error("Failed to delete expense");
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert(error.message);
          });
      }

      // Add event listener for the add expense form submission
      document
        .getElementById("addExpenseForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();

          const form = event.target;
          const formData = new FormData(form);
          const expense = {};

          for (let [key, value] of formData.entries()) {
            expense[key] = value;
          }

          const expenseAmount = parseFloat(expense.amount);

          if (!isNaN(expenseAmount)) {
            expense.amount = expenseAmount;

            const userDetails = JSON.parse(localStorage.getItem("userDetails"));
            const userId = userDetails ? userDetails.id : null;
            const token = localStorage.getItem("token");

            if (userId) {
              fetch(`http://localhost:8080/expense/add-expense`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify(expense),
              })
                .then((response) => {
                  if (response.ok) {
                    alert("Expense saved successfully!");
                    form.reset();
                    fetchExpenses(); // Fetch and display updated expenses
                  } else {
                    throw new Error("Failed to save expense");
                  }
                })
                .catch((error) => {
                  console.error("Error:", error);
                  alert(error.message);
                });
            } else {
              alert("User details not found. Please log in again.");
            }
          } else {
            alert("Invalid expense amount. Please enter a valid number.");
          }
        });

      // Fetch and display expenses when the page loads
      document.addEventListener("DOMContentLoaded", fetchExpenses());
    </script>
  </body>
</html>
